-------------------------
title: SpringCloud Ribbon
tags: SpringCloud
categories: Spring
date: 2018-03-30 18:00:01
-------------------------

### Description
ribbon是一个负载均衡客户端，可以很好的控制http和tcp的一些行为，它是基于Netflix Ribbon实现的。它不像服务注册中心，API网关，配置中心那样独立部署，但是他几乎存在于每个微服务的基础设施中，主要功能是 提供客户端的软件负载均衡算法，将Netflix的中间层服务连接在一起。Ribbon客户端组件提供一系列完善的配置，在配置文件中列出Load Balancer(LB)后面所有的机器，Ribbon会自动的帮助你基于某种规则去连接这种机器。

### LB 方案分类
目前主流的LB方案可分为两类：一种是集中是LB，即在服务的消费方和提供方之间使用独立的LB设施(可以是硬件，如F5，也可以是软件，如nginx)，由该设施负责把访问请求通过某种策略转发至服务的提供方；另一种是进程内LB，将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个合适的服务器。Ribbon就属于后者，它只是一个类库，集成于消费方进程，消费方通过它来获取到服务提供方的地址。

### Ribbon的主要组件与工作流程
Ribbon的核心组件 :   

- ServerList   

用于获取地址列表，它既可以是静态的(提供一组固定的地址)，也可以是动态的(从注册中心中定期查询地址列表)

- ServerListFilter

仅当使用动态ServerList时使用，用于在原始的服务列表中使用一定的策略过滤掉一部分地址。

- IRule

选择一个最终的服务地址作为LB结果，选择策略有轮询，根据相应时间加权，断路器等。

Ribbon在工作是首选会通过ServerList来获取所有可用的服务列表，然后通过ServerListFilter过滤掉一部分地址，最后在剩下的地址中通过IRule选择传一台服务器作为最终结果。

### Ribbon 提供的主要负载均衡策略

#### 1. 简单轮询负载均衡
以轮询的方式依次将请求调度到不同的服务器，即每次调度执行 i = (i + 1)mod n ，并选出第 i 台服务器。

#### 2. 随机负载均衡
随机选择状态为UP 的Server

#### 3. 加权响应时间负载均衡
根据相应时间分配一个weight，响应时间越长，weight越小，被选中的可能性越低。

#### 4. 区域感知轮询负载均衡
符合判断server所在区域的性能和server的可用性选择server。